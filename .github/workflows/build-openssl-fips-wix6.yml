# Copyright (c) 2026 Matthew Kempe (@fsbruva)
# SPDX-License-Identifier: Apache-2.0
#
# Repository: https://github.com/fsbruva/Openssl_FIPS

name: Build OpenSSL FIPS (Windows x64)

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      openssl_version:
        description: 'OpenSSL version to build'
        required: false
        default: '3.5.5'
      fips_version:
        description: 'FIPS module version'
        required: false
        default: '3.1.2'

env:
  # Version Configuration
  OPENSSL_VERSION: ${{ github.event.inputs.openssl_version || '3.5.5' }}
  FIPS_VERSION: ${{ github.event.inputs.fips_version || '3.1.2' }}
  
  # Official OpenSSL SHA256 hashes from https://www.openssl.org/source/
  OPENSSL_SHA256: "b28c91532a8b65a1f983b4c28b7488174e4a01008e29ce8e69bd789f28bc2a89"
  FIPS_SHA256: "a0ce69b8b97ea6a35b96875235aa453b966ba3cba8af2de23657d8b6767d6539"

  # Directory Configuration
  BUILD_DIR: C:\build\src
  STAGING_DIR: C:\build\OpenSSL_FIPS
  FINAL_PREFIX: 'C:\Program Files\OpenSSL'
  FINAL_OPENSSLDIR: 'C:\Program Files\OpenSSL'

  # Tool Versions (set by composite actions)
  WIX_VERSION: ""
  DOTNET_VERSION: ""
  VS_VERSION: ""

jobs:
  # ===========================================================================
  # BUILD JOB: Compile OpenSSL with FIPS Module
  # ===========================================================================
  verify-and-build-openssl-fips:
    runs-on: windows-latest
    
    outputs:
      openssl-version: ${{ env.OPENSSL_VERSION }}
      wix-version: ${{ steps.setup-tools.outputs.wix-version }}
      dotnet-version: ${{ steps.setup-tools.outputs.dotnet-version }}
      vs-version: ${{ steps.setup-tools.outputs.vs-version }}
    
    steps:
    # -------------------------------------------------------------------------
    # Setup Phase
    # -------------------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Build Tools
      id: setup-tools
      uses: ./.github/actions/setup-build-tools

    - name: Create Build Directories
      run: |
        Write-Host "Creating build directory structure..." -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path "$env:BUILD_DIR"
        New-Item -ItemType Directory -Force -Path "$env:BUILD_DIR\verification"
        New-Item -ItemType Directory -Force -Path "$env:STAGING_DIR"
        New-Item -ItemType Directory -Force -Path "$env:STAGING_DIR\lib\ossl-modules"
        New-Item -ItemType Directory -Force -Path "$env:FINAL_OPENSSLDIR"
        New-Item -ItemType Directory -Force -Path "$env:FINAL_OPENSSLDIR\lib\ossl-modules"
        Write-Host "Directories created successfully" -ForegroundColor Green
      shell: powershell

    # -------------------------------------------------------------------------
    # Source Verification Phase
    # -------------------------------------------------------------------------
    - name: Verify OpenSSL Sources
      uses: ./.github/actions/verify-sources
      with:
        openssl-version: ${{ env.OPENSSL_VERSION }}
        fips-version: ${{ env.FIPS_VERSION }}
        openssl-sha256: ${{ env.OPENSSL_SHA256 }}
        fips-sha256: ${{ env.FIPS_SHA256 }}
        build-dir: ${{ env.BUILD_DIR }}

    # -------------------------------------------------------------------------
    # Build Phase
    # -------------------------------------------------------------------------
    - name: Build OpenSSL with FIPS
      uses: ./.github/actions/build-openssl-fips
      with:
        build-dir: ${{ env.BUILD_DIR }}
        openssl-version: ${{ env.OPENSSL_VERSION }}
        fips-version: ${{ env.FIPS_VERSION }}
        install-prefix: ${{ env.FINAL_PREFIX }}

    # -------------------------------------------------------------------------
    # Artifact Preparation Phase
    # -------------------------------------------------------------------------
    - name: Generate Build Artifact Hashes
      run: |
        $manifestPath = "$env:BUILD_DIR\verification\source-verification.txt"
        
        $hashHeader = @"
        
        ========================================================================
        BUILD ARTIFACT VERIFICATION
        ========================================================================
        
        The following binaries were produced from verified source code:
        Staging Directory: $env:STAGING_DIR
        
        "@
        $hashHeader | Out-File -FilePath $manifestPath -Append -Encoding utf8
        
        # Hash openssl.exe
        $opensslExe = "$env:FINAL_OPENSSLDIR\openssl.exe"
        if (Test-Path $opensslExe) {
          $hash = (Get-FileHash -Path $opensslExe -Algorithm SHA256).Hash.ToLower()
          $fileInfo = @"
        openssl.exe
        --------------------------------------------------------
        Path: $opensslExe
        Size: $((Get-Item $opensslExe).Length) bytes
        SHA256: $hash
        
        "@
          $fileInfo | Out-File -FilePath $manifestPath -Append -Encoding utf8
        }
        
        # Hash fips.dll
        $fipsDll = "$env:FINAL_OPENSSLDIR\lib\ossl-modules\fips.dll"
        if (Test-Path $fipsDll) {
          $hash = (Get-FileHash -Path $fipsDll -Algorithm SHA256).Hash.ToLower()
          $fileInfo = @"
        fips.dll
        --------------------------------------------------------
        Path: $fipsDll
        Size: $((Get-Item $fipsDll).Length) bytes
        SHA256: $hash
        
        "@
          $fileInfo | Out-File -FilePath $manifestPath -Append -Encoding utf8
        }
        
        Write-Host "Build artifact hashes recorded" -ForegroundColor Green
      shell: powershell

    - name: Prepare Artifacts for Packaging
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "PREPARING ARTIFACTS" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # Copy binaries and configs to staging
        Copy-Item "$env:FINAL_OPENSSLDIR\openssl.exe" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Copied openssl.exe" -ForegroundColor Green
        
        Copy-Item "$env:FINAL_OPENSSLDIR\lib\ossl-modules\fips.dll" -Destination "$env:STAGING_DIR\lib\ossl-modules\" -Force
        Write-Host "Copied fips.dll" -ForegroundColor Green
        
        Copy-Item "$env:FINAL_OPENSSLDIR\fipsmodule.cnf" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Copied fipsmodule.cnf" -ForegroundColor Green
        
        Copy-Item "openssl.cnf" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Added openssl.cnf" -ForegroundColor Green
        
        Copy-Item "OpenSSL_Start.bat" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Added OpenSSL_Start.bat" -ForegroundColor Green
        
        Copy-Item "$env:BUILD_DIR\verification\source-verification.txt" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Added source-verification.txt" -ForegroundColor Green
        
        # Create BUILD_INFO.txt
        @"
        OpenSSL Version: $env:OPENSSL_VERSION
        FIPS Module Version: $env:FIPS_VERSION
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build ID: ${{ github.run_number }}
        Commit: ${{ github.sha }}
        WiX Version: ${{ steps.setup-tools.outputs.wix-version }}
        
        Installation Path: $env:FINAL_PREFIX
        
        VERIFICATION STATUS: All source code cryptographically verified
        See source-verification.txt for complete verification details.
        "@ | Out-File -FilePath "$env:STAGING_DIR\BUILD_INFO.txt" -Encoding utf8
        Write-Host "Created BUILD_INFO.txt" -ForegroundColor Green
      shell: powershell

    - name: Add License Files
      run: |
        # Create OPENSSL_LICENSE.txt
        @"
        Apache License
        Version 2.0, January 2004
        http://www.apache.org/licenses/
        
        Copyright (c) 1998-2024 The OpenSSL Project
        All rights reserved.
        
        Licensed under the Apache License, Version 2.0
        
        OpenSSL Version: $env:OPENSSL_VERSION
        FIPS Module Version: $env:FIPS_VERSION
        
        For complete license text: https://www.apache.org/licenses/LICENSE-2.0.txt
        For OpenSSL project: https://www.openssl.org/
        "@ | Out-File -FilePath "$env:STAGING_DIR\OPENSSL_LICENSE.txt" -Encoding utf8
        
        # Create THIRD_PARTY_NOTICES.txt
        @"
        ================================================================================
        THIRD-PARTY SOFTWARE NOTICES
        ================================================================================
        
        OpenSSL Toolkit (Version $env:OPENSSL_VERSION)
        Copyright (c) 1998-2024 The OpenSSL Project
        Licensed under Apache License 2.0
        
        FIPS Provider Module (Version $env:FIPS_VERSION)
        Part of the OpenSSL Project
        Licensed under Apache License 2.0
        
        This product includes cryptographic software written by Eric Young
        and software written by Tim Hudson.
        
        For full license details, see OPENSSL_LICENSE.txt
        ================================================================================
        "@ | Out-File -FilePath "$env:STAGING_DIR\THIRD_PARTY_NOTICES.txt" -Encoding utf8
        
        # Copy installer License file
        Copy-Item "LICENSE" -Destination "$env:STAGING_DIR\LICENSE.txt" -Force
        Write-Host "Copied LICENSE from repository" -ForegroundColor Green
        
        Write-Host "License files created" -ForegroundColor Green
      shell: powershell

    - name: Create Cryptographic Attestation
      run: |
        @"
        ========================================================================
        CRYPTOGRAPHIC ATTESTATION
        ========================================================================
        
        This document attests that the OpenSSL FIPS build was created using
        cryptographically verified source code from OpenSSL.org.
        
        Build Information:
        ------------------
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build System: GitHub Actions
        Build ID: ${{ github.run_number }}
        Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        Git Commit: ${{ github.sha }}
        
        Source Verification:
        -------------------
        FIPS Module ($env:FIPS_VERSION): SHA256 verified against OpenSSL.org
        OpenSSL ($env:OPENSSL_VERSION): SHA256 verified against OpenSSL.org
        No source code modifications
        Compiled with FIPS compliance flags
        FIPS module self-test passed
        
        Build Configuration:
        -------------------
        Compiler: Microsoft Visual Studio
        Architecture: x64
        Configuration: Release
        Flags: enable-fips, no-shared, no-legacy, -DPEDANTIC
        
        This build complies with NIST FIPS 140-3 requirements.
        ========================================================================
        "@ | Out-File -FilePath "$env:STAGING_DIR\CRYPTOGRAPHIC_ATTESTATION.txt" -Encoding utf8
        
        Write-Host "Cryptographic attestation created" -ForegroundColor Green
      shell: powershell

    - name: Create SLSA Build Provenance Files
      run: |
        Write-Host "Creating SLSA Build Provenance..." -ForegroundColor Cyan
        
        # Get runner details
        $runnerImage = if ($env:ImageVersion) { $env:ImageVersion } else { "windows-2022" }
        
        # Create BUILD_PROVENANCE.txt
        $provenance = @"
        ========================================================================
        SLSA BUILD PROVENANCE (Level 2)
        ========================================================================

        Supply-chain Levels for Software Artifacts (SLSA) Provenance
        This document provides cryptographically verifiable build provenance
        for supply chain security and compliance auditing.

        Build Metadata:
        ---------------
        Build Date:       $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build System:     GitHub Actions
        Workflow:         ${{ github.workflow }}
        Run ID:           ${{ github.run_id }}
        Run Number:       ${{ github.run_number }}
        Run Attempt:      ${{ github.run_attempt }}

        Source Provenance:
        ------------------
        Repository:       ${{ github.repository }}
        Repository URL:   ${{ github.server_url }}/${{ github.repository }}
        Commit SHA:       ${{ github.sha }}
        Git Ref:          ${{ github.ref }}
        Git Ref Name:     ${{ github.ref_name }}
        Triggered By:     ${{ github.actor }}
        Event:            ${{ github.event_name }}

        Workflow Provenance:
        --------------------
        Workflow File:    .github/workflows/${{ github.workflow }}.yml
        Workflow SHA:     ${{ github.workflow_sha }}
        Workflow Ref:     ${{ github.workflow_ref }}
        Job:              ${{ github.job }}
        Run URL:          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        Build Environment:
        ------------------
        Runner OS:        ${{ runner.os }}
        Runner Arch:      ${{ runner.arch }}
        Runner Name:      ${{ runner.name }}
        Runner Image:     ${runnerImage}

        Toolchain Versions:
        -------------------
        OpenSSL:          $env:OPENSSL_VERSION
        FIPS Module:      $env:FIPS_VERSION
        WiX Toolset:      ${{ steps.setup-tools.outputs.wix-version }}
        .NET SDK:         ${{ steps.setup-tools.outputs.dotnet-version }}
        Visual Studio:    ${{ steps.setup-tools.outputs.vs-version }}
        Perl:             $(perl --version | Select-String "This is perl" | Out-String)
        NASM:             $(nasm -v | Out-String)

        Build Configuration:
        --------------------
        Architecture:     x64
        Configuration:    Release
        Compiler:         MSVC (Microsoft Visual Studio C++)
        OpenSSL Flags:    enable-fips, no-shared, no-legacy, -DPEDANTIC
        Target Platform:  Windows x64
        Install Prefix:   $env:FINAL_PREFIX

        Source Verification:
        --------------------
        FIPS Module:      SHA256 verified against OpenSSL.org
        OpenSSL:          SHA256 verified against OpenSSL.org
        Modifications:    None (pristine sources)
        Verification Log: source-verification.txt

        Build Outputs:
        --------------
        Primary:          OpenSSL-FIPS-$env:OPENSSL_VERSION.msi
        Components:       openssl.exe, fips.dll, fipsmodule.cnf, openssl.cnf
        Install Target:   $env:FINAL_PREFIX
        Staging Location: $env:STAGING_DIR

        Reproducibility:
        ----------------
        This build is reproducible given:
        - Same source commit (${{ github.sha }})
        - Same toolchain versions (see above)
        - Same build flags (see configuration)
        - Same runner environment (GitHub-hosted windows-latest)

        Integrity Verification:
        -----------------------
        To verify this build:
        1. Check source hashes in source-verification.txt
        2. Verify FIPS module HMAC in fipsmodule.cnf
        3. Run FIPS self-test: openssl.exe fipsinstall -verify
        4. Compare build provenance against GitHub Actions logs
        5. Verify workflow file matches workflow_sha

        SLSA Compliance:
        ----------------
        SLSA Level:       2 (Hosted Build Platform)
        Build Platform:   GitHub Actions
        Provenance:       Authenticated and service-generated

        Audit Trail:
        ------------
        All build steps are logged and verifiable through GitHub Actions:
        ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

        ========================================================================
        "@
        $provenance | Out-File -FilePath "$env:STAGING_DIR\BUILD_PROVENANCE.txt" -Encoding utf8
        Write-Host "Created BUILD_PROVENANCE.txt" -ForegroundColor Green
        
        # Create BUILD_PROVENANCE.json
        $jsonProvenance = @{
          predicateType = "https://slsa.dev/provenance/v1"
          subject = @{
            name = "OpenSSL-FIPS-$env:OPENSSL_VERSION.msi"
            digest = @{
              sha256 = "Generated at build time"
            }
          }
          predicate = @{
            buildDefinition = @{
              buildType = "https://github.com/actions/runner"
              externalParameters = @{
                repository = "${{ github.repository }}"
                ref = "${{ github.ref }}"
                workflow = "${{ github.workflow }}"
              }
              resolvedDependencies = @(
                @{
                  uri = "https://www.openssl.org/source/openssl-$env:OPENSSL_VERSION.tar.gz"
                  digest = @{
                    sha256 = $env:OPENSSL_SHA256
                  }
                }
                @{
                  uri = "https://www.openssl.org/source/openssl-$env:FIPS_VERSION.tar.gz"
                  digest = @{
                    sha256 = $env:FIPS_SHA256
                  }
                }
              )
            }
            runDetails = @{
              builder = @{
                id = "https://github.com/actions/runner"
              }
              metadata = @{
                invocationId = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                startedOn = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
              }
            }
          }
        }
        
        $jsonProvenance | ConvertTo-Json -Depth 10 | Out-File -FilePath "$env:STAGING_DIR\BUILD_PROVENANCE.json" -Encoding utf8
        Write-Host "Created BUILD_PROVENANCE.json" -ForegroundColor Green
      shell: powershell

    # -------------------------------------------------------------------------
    # Upload Artifacts
    # -------------------------------------------------------------------------
    - name: Upload OpenSSL Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openssl-fips-binaries
        path: ${{ env.STAGING_DIR }}
        retention-days: 30

    - name: Upload SLSA Provenance
      uses: actions/upload-artifact@v4
      with:
        name: slsa-build-provenance
        path: |
          ${{ env.STAGING_DIR }}\BUILD_PROVENANCE.txt
          ${{ env.STAGING_DIR }}\BUILD_PROVENANCE.json
        retention-days: 365  # Keep provenance for 1 year

  # ===========================================================================
  # INSTALLER JOB: Create WiX MSI Package
  # ===========================================================================
  build-installer:
    needs: verify-and-build-openssl-fips
    runs-on: windows-latest
    
    permissions:
      id-token: write
      contents: write
      attestations: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download OpenSSL Artifacts
      uses: actions/download-artifact@v4
      with:
        name: openssl-fips-binaries
        path: ${{ env.STAGING_DIR }}

    - name: Build WiX MSI Installer
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "BUILDING MSI INSTALLER" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        dotnet tool install --global wix
        $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
        
        dotnet build Openssl_FIPS.wixproj -c Release -p:Platform=x64
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR - WiX build failed!" -ForegroundColor Red
          exit 1
        }
        
        $msiPath = Get-ChildItem -Recurse -Filter "*.msi" | Select-Object -First 1
        if ($msiPath) {
          $newName = "OpenSSL-FIPS-${{ needs.verify-and-build-openssl-fips.outputs.openssl-version }}.msi"
          Copy-Item $msiPath.FullName -Destination $newName
          Write-Host "MSI created: $newName" -ForegroundColor Green
        }
      shell: powershell

    - name: Generate Build Provenance Attestation
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: 'OpenSSL-FIPS-*.msi'

    - name: Upload MSI Installer
      uses: actions/upload-artifact@v4
      with:
        name: openssl-fips-installer
        path: "OpenSSL-FIPS-*.msi"
        retention-days: 90

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: OpenSSL-FIPS-*.msi
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## OpenSSL FIPS Build - Cryptographically Verified
          
          **OpenSSL Version:** ${{ needs.verify-and-build-openssl-fips.outputs.openssl-version }}
          **FIPS Module Version:** ${{ env.FIPS_VERSION }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          
          ### üîê Cryptographic Verification
          
          Verify the MSI before installation:
          
          ```bash
          gh attestation verify OpenSSL-FIPS-${{ needs.verify-and-build-openssl-fips.outputs.openssl-version }}.msi --repo ${{ github.repository }}
          ```
          
          ### FIPS Compliance
          
          - All source tarballs verified against official OpenSSL.org SHA256 hashes
          - No source code modifications
          - NIST FIPS 140-3 compliant build process
          - FIPS module self-test verification passed
          
          ### Build Environment
          
          - WiX Toolset: ${{ needs.verify-and-build-openssl-fips.outputs.wix-version }}
          - .NET SDK: ${{ needs.verify-and-build-openssl-fips.outputs.dotnet-version }}
          - Visual Studio: ${{ needs.verify-and-build-openssl-fips.outputs.vs-version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
