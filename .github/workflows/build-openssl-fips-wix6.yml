name: Build OpenSSL FIPS (Windows x64)

# WiX Toolset Build with FIPS-Compliant Hash Verification

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      openssl_version:
        description: 'OpenSSL version to build'
        required: false
        default: '3.5.5'
      fips_version:
        description: 'FIPS module version'
        required: false
        default: '3.1.2'

env:
  # Official OpenSSL SHA256 hashes from https://www.openssl.org/source/
  # IMPORTANT: Update these when changing versions
  OPENSSL_VERSION: '3.5.5'
  OPENSSL_SHA256: "b28c91532a8b65a1f983b4c28b7488174e4a01008e29ce8e69bd789f28bc2a89"

  FIPS_VERSION: '3.1.2'
  FIPS_SHA256: "a0ce69b8b97ea6a35b96875235aa453b966ba3cba8af2de23657d8b6767d6539"

  # FIPS Module must be certified by NIST, so the FIPS module will rarely change

  ###################################################################################

  BUILD_DIR: C:\build\src
  STAGING_DIR: C:\build\OpenSSL_FIPS
  
  # OpenSSL configure uses these for runtime paths (where it will be installed on target system)
  FINAL_PREFIX: 'C:\Program Files\OpenSSL'
  FINAL_OPENSSLDIR: 'C:\Program Files\OpenSSL'

  # Tooling versions (discovered at runtime)
  WIX_VERSION: ""
  DOTNET_VERSION: ""
  VS_VERSION: ""
    
jobs:
  verify-and-build-openssl-fips:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild (Visual Studio)
      uses: microsoft/setup-msbuild@v2

    - name: Setup Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        
    - name: Verify build tools
      run: |
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        
        Write-Host "Build Tools Verification:" -ForegroundColor Cyan
        Write-Host "=========================" -ForegroundColor Cyan
        
        Write-Host "`nNASM:"
        where.exe nasm
        nasm -version
        
        Write-Host "`nPerl:"
        where.exe perl
        perl --version | Select-Object -First 2
        
        Write-Host "`n.NET SDK:"
        dotnet --version
        
        Write-Host "`nWiX:"
        wix --version
        
      shell: powershell

    - name: Create build, staging and install directories
      run: |
        # Build directory - where we extract and compile source
        New-Item -ItemType Directory -Force -Path "$env:BUILD_DIR"
        
        # Staging directory - where OpenSSL will prep its files (our artifact directory)
        New-Item -ItemType Directory -Force -Path "$env:STAGING_DIR"
               New-Item -ItemType Directory -Force -Path "$env:STAGING_DIR\lib\ossl-modules"

        # Install directory - where OpenSSL will be installed
        New-Item -ItemType Directory -Force -Path "$env:FINAL_OPENSSLDIR"
        New-Item -ItemType Directory -Force -Path "$env:FINAL_OPENSSLDIR\lib\ossl-modules"
        
        # Verification directory - for hash verification logs
        New-Item -ItemType Directory -Force -Path "$env:BUILD_DIR\verification"
        
        Write-Host "Directory structure created:" -ForegroundColor Green
        Write-Host "  Build: $env:BUILD_DIR" -ForegroundColor Gray
        Write-Host "  Staging: $env:STAGING_DIR" -ForegroundColor Gray
        Write-Host "  Verification: $env:BUILD_DIR\verification" -ForegroundColor Gray
      shell: powershell

    # ==========================================
    # FIPS COMPLIANCE: Source Code Verification
    # ==========================================
    
    - name: Create verification manifest header
      run: |
        $manifestPath = "$env:BUILD_DIR\verification\source-verification.txt"
        
        @"
        ========================================================================
        OpenSSL FIPS Build - Source Code Verification Manifest
        ========================================================================
        
        Build Information:
        ------------------
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build ID: ${{ github.run_number }}
        Commit SHA: ${{ github.sha }}
        Triggered By: ${{ github.event_name }}
        Runner OS: ${{ runner.os }}
        
        OpenSSL Version: $env:OPENSSL_VERSION
        FIPS Module Version: $env:FIPS_VERSION
        
        Build Tools:
        ------------------
        WiX Toolset: $env.WIX_VERSION
        .NET SDK: $env.DOTNET_VERSION
        Visual Studio: $env:VS_VERSION
        
        ========================================================================
        CRYPTOGRAPHIC VERIFICATION
        ========================================================================
        
        "@ | Out-File -FilePath $manifestPath -Encoding utf8
        
        Write-Host "Verification manifest created" -ForegroundColor Green
      shell: powershell

    - name: Download and verify FIPS module source
      run: |
        $fipsUrl = "https://www.openssl.org/source/openssl-$env:FIPS_VERSION.tar.gz"
        $fipsFile = "$env:BUILD_DIR\openssl-$env:FIPS_VERSION.tar.gz"
        $manifestPath = "$env:BUILD_DIR\verification\source-verification.txt"
        
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "DOWNLOADING FIPS MODULE SOURCE" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "URL: $fipsUrl"
        Write-Host "Expected SHA256: $env:FIPS_SHA256"
        Write-Host ""
        
        # Download
        Invoke-WebRequest -Uri $fipsUrl -OutFile $fipsFile
        
        # Calculate actual hash
        $actualHash = (Get-FileHash -Path $fipsFile -Algorithm SHA256).Hash.ToLower()
        $expectedHash = $env:FIPS_SHA256.ToLower()
        
        # Log to manifest
        @"
        
        FIPS Module Source (openssl-$env:FIPS_VERSION.tar.gz)
        --------------------------------------------------------
        Download URL: $fipsUrl
        Download Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        File Size: $((Get-Item $fipsFile).Length) bytes
        
        Expected SHA256: $expectedHash
        Actual SHA256:   $actualHash
        Verification:    $(if ($actualHash -eq $expectedHash) { "PASSED" } else { "FAILED" })
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        
        # Verify hash
        if ($actualHash -ne $expectedHash) {
          Write-Host "VERIFICATION FAILED!" -ForegroundColor Red
          Write-Host "Expected: $expectedHash" -ForegroundColor Red
          Write-Host "Actual:   $actualHash" -ForegroundColor Red
          throw "FIPS module source verification failed. Hash mismatch detected."
        }
        
        Write-Host "FIPS module source verified successfully!" -ForegroundColor Green
        Write-Host "Hash: $actualHash" -ForegroundColor Green
        Write-Host ""
      shell: powershell

    - name: Download and verify OpenSSL source
      run: |
        $opensslUrl = "https://www.openssl.org/source/openssl-$env:OPENSSL_VERSION.tar.gz"
        $opensslFile = "$env:BUILD_DIR\openssl-$env:OPENSSL_VERSION.tar.gz"
        $manifestPath = "$env:BUILD_DIR\verification\source-verification.txt"
        
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "DOWNLOADING OPENSSL SOURCE" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "URL: $opensslUrl"
        Write-Host "Expected SHA256: $env:OPENSSL_SHA256"
        Write-Host ""
        
        # Download
        Invoke-WebRequest -Uri $opensslUrl -OutFile $opensslFile
        
        # Calculate actual hash
        $actualHash = (Get-FileHash -Path $opensslFile -Algorithm SHA256).Hash.ToLower()
        $expectedHash = $env:OPENSSL_SHA256.ToLower()
        
        # Log to manifest
        @"
        
        OpenSSL Source (openssl-$env:OPENSSL_VERSION.tar.gz)
        --------------------------------------------------------
        Download URL: $opensslUrl
        Download Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        File Size: $((Get-Item $opensslFile).Length) bytes
        
        Expected SHA256: $expectedHash
        Actual SHA256:   $actualHash
        Verification:    $(if ($actualHash -eq $expectedHash) { "PASSED" } else { "FAILED" })
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        
        # Verify hash
        if ($actualHash -ne $expectedHash) {
          Write-Host "VERIFICATION FAILED!" -ForegroundColor Red
          Write-Host "Expected: $expectedHash" -ForegroundColor Red
          Write-Host "Actual:   $actualHash" -ForegroundColor Red
          throw "OpenSSL source verification failed. Hash mismatch detected."
        }
        
        Write-Host "OpenSSL source verified successfully!" -ForegroundColor Green
        Write-Host "Hash: $actualHash" -ForegroundColor Green
        Write-Host ""
      shell: powershell

    - name: Extract verified sources
      run: |
        $manifestPath = "$env:BUILD_DIR\verification\source-verification.txt"
        
        Write-Host "Extracting verified sources..." -ForegroundColor Cyan
        
        # Extract FIPS module
        tar -xzf "$env:BUILD_DIR\openssl-$env:FIPS_VERSION.tar.gz" -C $env:BUILD_DIR
        
        # Extract OpenSSL
        tar -xzf "$env:BUILD_DIR\openssl-$env:OPENSSL_VERSION.tar.gz" -C $env:BUILD_DIR
        
        @"
        
        ========================================================================
        EXTRACTION COMPLETE
        ========================================================================
        
        Both source archives have been:
        1. Downloaded from official OpenSSL.org sources
        2. Verified against official SHA256 hashes
        3. Extracted without modification
        
        The build process will now proceed using only verified source code.
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        
        Write-Host "Sources extracted successfully" -ForegroundColor Green
      shell: powershell

    # ==========================================
    # Build Process (Using Verified Sources)
    # ==========================================

    - name: Build FIPS Module
      run: |
        cd /d "%BUILD_DIR%\openssl-%FIPS_VERSION%"
        if %ERRORLEVEL% NEQ 0 (
          echo ERROR: Failed to change to FIPS source directory
          exit /b 1
        )        
        
        echo ========================================
        echo BUILDING FIPS MODULE
        echo ========================================
        echo Current directory: %CD%
        echo Install prefix: %ProgramW6432%\OpenSSL
        echo.
        
        REM Configure with final installation path
        REM This ensures binaries look for files in the correct location at runtime
        perl Configure VC-WIN64A enable-fips --release no-shared no-legacy --prefix="%ProgramW6432%\OpenSSL" --openssldir="%ProgramW6432%\OpenSSL" -DPEDANTIC
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        nmake build_sw
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        nmake test
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        nmake install_fips
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        echo FIPS module built successfully
      shell: cmd

    - name: Build OpenSSL with FIPS
      run: |
        cd /d "%BUILD_DIR%\openssl-%OPENSSL_VERSION%"
        if %ERRORLEVEL% NEQ 0 (
          echo ERROR: Failed to change to OpenSSL source directory
          exit /b 1
        )
        
        echo ========================================
        echo BUILDING OPENSSL WITH FIPS
        echo ========================================
        echo Install prefix: %ProgramW6432%\OpenSSL
        echo Current directory: %CD%
        echo.
        
        REM Configure with final installation path
        perl Configure VC-WIN64A enable-fips --release no-shared no-legacy --prefix="%ProgramW6432%\OpenSSL" --openssldir="%ProgramW6432%\OpenSSL" -DPEDANTIC
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        nmake build_sw
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        REM Copy FIPS module from Program Files (already built)
        copy "%FINAL_OPENSSLDIR%\lib\ossl-modules\fips.dll" providers\
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%

        copy "%FINAL_OPENSSLDIR%\fipsmodule.cnf" providers\
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%

        nmake test
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        nmake install_runtime
        if %ERRORLEVEL% NEQ 0 exit /b %ERRORLEVEL%
        
        echo OpenSSL built successfully
      shell: cmd


    - name: Generate FIPS module HMAC and finalize installation
      run: |
        
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "GENERATING FIPS MODULE HMAC" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
  
        # Move openssl binary
        Move-Item "$env:FINAL_OPENSSLDIR\bin\openssl.exe" "$env:FINAL_OPENSSLDIR\openssl.exe" -Force
        Write-Host "Moved openssl.exe to root directory" -ForegroundColor Green
        
        # Copy openssl.cnf from repository
        Copy-Item "openssl.cnf" "$env:FINAL_OPENSSLDIR\" -Force
        Write-Host "Installed openssl.cnf" -ForegroundColor Green

        # Change to OpenSSL directory
        Push-Location "$env:FINAL_OPENSSLDIR"

        # Generate fipsmodule.cnf with HMAC
        Write-Host "`nGenerating FIPS module configuration with HMAC..." -ForegroundColor Cyan

        # Run fipsinstall with relative paths (relative to OpenSSL directory)
        & ".\openssl.exe" fipsinstall `
          -out "fipsmodule.cnf" `
          -module "lib\ossl-modules\fips.dll" `
          -self_test_onload

        # Return to previous directory
        Pop-Location

        if ($LASTEXITCODE -ne 0) {
          Write-Host "FIPS module configuration generation failed!" -ForegroundColor Red
          exit 1
        }

        Write-Host "FIPS module HMAC generated successfully" -ForegroundColor Green

        # Verify the HMAC was added
        Write-Host "`nVerifying fipsmodule.cnf contains HMAC:" -ForegroundColor Cyan
        Get-Content "$env:FINAL_OPENSSLDIR\fipsmodule.cnf" | Select-String "install-mac"
      shell: powershell

    # ==========================================
    # Post-Build Verification
    # ==========================================

    - name: Generate build artifact hashes
      run: |
        $manifestPath = "$env:BUILD_DIR\verification\source-verification.txt"
        
        @"
        
        ========================================================================
        BUILD ARTIFACT VERIFICATION
        ========================================================================
        
        The following binaries were produced from verified source code:
        Staging Directory: $env:STAGING_DIR
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        
        # Hash openssl.exe
        $opensslExe = "$env:FINAL_OPENSSLDIR\openssl.exe"
        if (Test-Path $opensslExe) {
          $hash = (Get-FileHash -Path $opensslExe -Algorithm SHA256).Hash.ToLower()
          @"
        openssl.exe
        --------------------------------------------------------
        Path: $opensslExe
        Size: $((Get-Item $opensslExe).Length) bytes
        SHA256: $hash
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        }
        
        # Hash fips.dll
        $fipsDll = "$env:FINAL_OPENSSLDIR\lib\ossl-modules\fips.dll"
        if (Test-Path $fipsDll) {
          $hash = (Get-FileHash -Path $fipsDll -Algorithm SHA256).Hash.ToLower()
          @"
        fips.dll
        --------------------------------------------------------
        Path: $fipsDll
        Size: $((Get-Item $fipsDll).Length) bytes
        SHA256: $hash
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        }
        
        # Hash fipsmodule.cnf
        $fipsConf = "$env:FINAL_OPENSSLDIR\fipsmodule.cnf"
        if (Test-Path $fipsConf) {
          $hash = (Get-FileHash -Path $fipsConf -Algorithm SHA256).Hash.ToLower()
          @"
        fipsmodule.cnf
        --------------------------------------------------------
        Path: $fipsConf
        Size: $((Get-Item $fipsConf).Length) bytes
        SHA256: $hash
        
        "@ | Out-File -FilePath $manifestPath -Append -Encoding utf8
        }
        
        Write-Host "Build artifact hashes recorded" -ForegroundColor Green
      shell: powershell

    - name: Prepare artifacts for packaging
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "PREPARING ARTIFACTS" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host ""
        
        # OpenSSL binaries are installed in $env:FINAL_OPENSSLDIR
        
        # Copy openssl.exe from root directory (it was moved out of bin\ earlier)
        if (Test-Path "$env:FINAL_OPENSSLDIR\openssl.exe") {
          Copy-Item "$env:FINAL_OPENSSLDIR\openssl.exe" -Destination "$env:STAGING_DIR\" -Force
          Write-Host "Copied openssl.exe to staging root" -ForegroundColor Green
        } else {
          Write-Host "ERROR: openssl.exe not found at $env:FINAL_OPENSSLDIR\openssl.exe" -ForegroundColor Red
          exit 1
        }
        
        # Copy fips.dll from install directory to staging directory
        if (Test-Path "$env:FINAL_OPENSSLDIR\lib\ossl-modules\fips.dll") {
          Copy-Item "$env:FINAL_OPENSSLDIR\lib\ossl-modules\fips.dll" -Destination "$env:STAGING_DIR\lib\ossl-modules\" -Force
          Write-Host "Copied fips.dll to staging" -ForegroundColor Green
        } else {
          Write-Host "ERROR: fips.dll not found" -ForegroundColor Red
          exit 1
        }

        # Copy fipsmodule.cnf from install directory to staging directory
        if (Test-Path "$env:FINAL_OPENSSLDIR\fipsmodule.cnf") {
          Copy-Item "$env:FINAL_OPENSSLDIR\fipsmodule.cnf" -Destination "$env:STAGING_DIR\" -Force
          Write-Host "Copied fipsmodule.cnf to staging" -ForegroundColor Green
        } else {
          Write-Host "ERROR: fipsmodule.cnf not found" -ForegroundColor Red
          exit 1
        }

        # Copy static config files from repo
        Copy-Item "openssl.cnf" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Added openssl.cnf" -ForegroundColor Green
        
        Copy-Item "OpenSSL_Start.bat" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Added OpenSSL_Start.bat" -ForegroundColor Green
        
        # Copy verification manifest
        Copy-Item "$env:BUILD_DIR\verification\source-verification.txt" -Destination "$env:STAGING_DIR\" -Force
        Write-Host "Added source-verification.txt" -ForegroundColor Green
        
        # Create version info file
        @"
        OpenSSL Version: $env:OPENSSL_VERSION
        FIPS Module Version: $env:FIPS_VERSION
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build ID: ${{ github.run_number }}
        Commit: ${{ github.sha }}
        WiX Version: ${{ env.WIX_VERSION }}
        
        Installation Notes:
        -------------------
        This build is configured to run from: $env:FINAL_PREFIX
        Files are staged in: $env:STAGING_DIR
        
        VERIFICATION STATUS: All source code cryptographically verified
        See source-verification.txt for complete verification details.
        "@ | Out-File -FilePath "$env:STAGING_DIR\BUILD_INFO.txt" -Encoding utf8
        Write-Host "Created BUILD_INFO.txt" -ForegroundColor Green
        
        Write-Host ""
        Write-Host "Staging directory contents:" -ForegroundColor Cyan
        Get-ChildItem -Recurse "$env:STAGING_DIR" | Format-Table Name, Length, Directory
      shell: powershell

    - name: Verify FIPS configuration
      run: |
        
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "FIPS MODULE VERIFICATION" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # Change to OpenSSL directory
        Push-Location "$env:FINAL_OPENSSLDIR"

        Write-Host "`nOpenSSL Version:"
        .\openssl.exe version
        
        Write-Host "`nAvailable Providers:"
        .\openssl.exe list -providers
        
        Write-Host "`nFIPS Module Self-Test:"
        .\openssl.exe fipsinstall -in "fipsmodule.cnf" -module "lib\ossl-modules\fips.dll" -verify -self_test_onload

        # Return to previous directory
        Pop-Location
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "FIPS module verification failed!"
          exit 1
        }
        
        Write-Host "`n FIPS module verified successfully!" -ForegroundColor Green
      shell: powershell

    - name: Create cryptographic attestation
      run: |
        $attestationPath = "$env:STAGING_DIR\CRYPTOGRAPHIC_ATTESTATION.txt"
        
        @"
        ========================================================================
        CRYPTOGRAPHIC ATTESTATION
        ========================================================================
        
        This document attests that the OpenSSL FIPS build was created using
        cryptographically verified source code from OpenSSL.org.
        
        Build Information:
        ------------------
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Build System: GitHub Actions (Windows Server 2022)
        Build ID: ${{ github.run_number }}
        Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        Git Commit: ${{ github.sha }}
        
        Source Verification:
        -------------------
        FIPS Module ($env:FIPS_VERSION): SHA256 verified against OpenSSL.org
        OpenSSL ($env:OPENSSL_VERSION): SHA256 verified against OpenSSL.org
        No source code modifications
        Compiled with FIPS compliance flags
        FIPS module self-test passed
        
        Verification Evidence:
        ---------------------
        Complete verification details are available in source-verification.txt
        
        Build Configuration:
        -------------------
        Compiler: Microsoft Visual Studio (MSVC)
        Architecture: x64
        Configuration: Release
        Flags: enable-fips, no-shared, no-legacy
        Installer: WiX Toolset ${{ env.DOTNET_VERSION }}
        
        Installation Paths:
        ------------------
        Staging Directory: $env:STAGING_DIR
        Target Install Path: $env:FINAL_PREFIX
        
        This build complies with NIST FIPS 140-3 requirements for
        cryptographic module validation.
        
        ========================================================================
        
        "@ | Out-File -FilePath $attestationPath -Encoding utf8
        
        Write-Host "Cryptographic attestation created" -ForegroundColor Green
      shell: powershell

    - name: Upload OpenSSL artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openssl-fips-binaries
        path: C:\build\OpenSSL_FIPS\
        retention-days: 30

    - name: Upload verification manifest
      uses: actions/upload-artifact@v4
      with:
        name: fips-verification-manifest
        path: C:\build\OpenSSL_FIPS\source-verification.txt
        retention-days: 90

    - name: Upload cryptographic attestation
      uses: actions/upload-artifact@v4
      with:
        name: cryptographic-attestation
        path: C:\build\OpenSSL_FIPS\CRYPTOGRAPHIC_ATTESTATION.txt
        retention-days: 90

  build-installer:
    runs-on: windows-latest
    needs: verify-and-build-openssl-fips
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download OpenSSL artifacts
      uses: actions/download-artifact@v4
      with:
        name: openssl-fips-binaries
        path: C:\build\OpenSSL_FIPS

    - name: Verify downloaded artifacts
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "ARTIFACT VERIFICATION" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        Write-Host "`nArtifact contents:"
        Get-ChildItem -Recurse C:\build\OpenSSL_FIPS | Format-Table Name, Length, LastWriteTime
        
        Write-Host "`n========================================" -ForegroundColor Cyan
        Write-Host "Build Information:"
        Get-Content C:\build\OpenSSL_FIPS\BUILD_INFO.txt
        
        Write-Host "`n========================================" -ForegroundColor Cyan
        Write-Host "Cryptographic Attestation:"
        Get-Content C:\build\OpenSSL_FIPS\CRYPTOGRAPHIC_ATTESTATION.txt
      shell: powershell

    - name: Install WiX Toolset
      run: |
        Write-Host "Installing WiX Toolset..." -ForegroundColor Cyan
        dotnet tool install --global wix
        
        # Add to PATH for current session
        $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
        
        # Verify installation
        $wixVersion = wix --version
        echo "WIX_VERSION=$wixVersion" >> $env:GITHUB_ENV        
        Write-Host "WiX $wixVersion installed successfully" -ForegroundColor Green
      shell: powershell

    - name: Capture build other toolchain versions
      shell: powershell
      run: |
        # .NET SDK
        $dotnetVersion = dotnet --version
        echo "DOTNET_VERSION=$dotnetVersion" >> $env:GITHUB_ENV

        # Visual Studio (authoritative)
        $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsVersion = & $vswhere -latest -property displayName
        echo "VS_VERSION=$vsVersion" >> $env:GITHUB_ENV

    - name: Build WiX MSI Installer
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "BUILDING MSI INSTALLER (WiX)" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
        
        # Ensure WiX is in PATH
        $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
        
        # WiX 6 uses dotnet build with the WiX SDK
        Write-Host "`nBuilding WiX project..."
        dotnet build Openssl_FIPS.wixproj -c Release -p:Platform=x64
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR - WiX build failed!" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "`nSUCCESS! MSI installer built successfully" -ForegroundColor Green
        
        # Find the generated MSI
        $msiPath = Get-ChildItem -Path . -Recurse -Filter "*.msi" | Select-Object -First 1
        
        if ($msiPath) {
          Write-Host "`nInstaller Details:" -ForegroundColor Cyan
          Write-Host "  File: $($msiPath.Name)"
          Write-Host "  Size: $([math]::Round($msiPath.Length / 1MB, 2)) MB"
          Write-Host "  Path: $($msiPath.FullName)"
          
          # Rename to include version
          $newName = "OpenSSL-FIPS-$env:OPENSSL_VERSION.msi"
          Copy-Item $msiPath.FullName -Destination $newName
          Write-Host "`n  Renamed to: $newName" -ForegroundColor Green
        } else {
          Write-Host "ERROR - MSI file not found after build!" -ForegroundColor Red
          exit 1
        }
      shell: powershell
      env:
        OPENSSL_VERSION: ${{ needs.verify-and-build-openssl-fips.env.OPENSSL_VERSION || '3.5.5' }}

    - name: Upload MSI Installer
      uses: actions/upload-artifact@v4
      with:
        name: openssl-fips-installer
        path: "OpenSSL-FIPS-*.msi"
        retention-days: 90

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          OpenSSL-FIPS-*.msi
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## OpenSSL FIPS Build - Cryptographically Verified
          
          **OpenSSL Version:** ${{ env.OPENSSL_VERSION }}
          **FIPS Module Version:** ${{ env.FIPS_VERSION }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          **Installer:** WiX Toolset ${{ env.WIX_VERSION }}
          
          ### FIPS Compliance
          
          This build includes cryptographic verification of all source code:
          -  All source tarballs verified against official OpenSSL.org SHA256 hashes
          -  No source code modifications
          -  NIST FIPS 140-3 compliant build process
          -  FIPS module self-test verification passed
          
          ### Verification Evidence
          
          Download the following artifacts for complete verification records:
          - `fips-verification-manifest`: Complete source verification details
          - `cryptographic-attestation`: Build attestation document
          
          ### Installation
          
          1. Download the MSI installer
          2. Run as Administrator
          3. Access via Start Menu â†’ OpenSSL FIPS
          
          ### Included Files
          
          - OpenSSL executable (`openssl.exe`)
          - FIPS provider module (`fips.dll`)
          - Configuration files (`openssl.cnf`, `fipsmodule.cnf`)
          - Verification wrapper (`OpenSSL_Start.bat`)
          - Source verification manifest
          - Cryptographic attestation
          
          ### Build Environment
          - OpenSSL ${{ env.OPENSSL_VERSION }} (FIPS ${{ env.FIPS_VERSION }})
          - WiX Toolset ${{ env.WIX_VERSION }}
          - .NET SDK ${{ env.DOTNET_VERSION }}
          - Visual Studio: ${{ env.VS_VERSION }}
          - GitHub Runner: ${{ runner.os }} / ${{ runner.arch }} (${{ runner.name }})
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}